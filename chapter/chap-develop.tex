
\chapter{虚拟化技术与资源调度系统}
\section{虚拟化技术}
在计算机科学中，虚拟化（Virtualization）是一个表现逻辑群组或电脑资源的子集的进程，用户可以用比原本的组态更好的方式来存取这些进程。这些资源的新虚拟部份是不受现有资源的架设方式，地域或物理组态所限制。一般所指的虚拟化资源包括计算能力和资料储存\cite{wiki}。
\subsection{虚拟化技术的分类}
按虚拟化的侧重，虚拟化技术可具体分为以下\cite{wiki}：
\begin{itemize}
  \item 虚拟机（Virtual machine或VM)，可以像真实机器一样运行程序的计算机的软件实现
  \begin{itemize}
    \item 平台虚拟化，将操作系统和硬件平台资源分割开
    \begin{itemize}%%\setlength{\itemsep}{18pt}
      \item 完全虚拟化，敏感指令在操作系统和硬件之间被捕捉处理，客户操作系统无需修改，所有软件都能在虚拟机中运行，例如IBM CP/CMS，VirtualBox，VMware Workstation
      \item 硬件辅助虚拟化，利用硬件（主要是CPU）辅助处理敏感指令以实现完全虚拟化的功能，客户操作系统无需修改，例如VMware Workstation，Xen，KVM
      \item 部分虚拟化，针对部分应用程序进行虚拟，而不是整个操作系统
      \item 准虚拟化/超虚拟化（paravirtualization），为应用程序提供与底层硬件相似但不相同的软件接口，客户操作系统需要进行修改，例如早期的Xen
      \item 操作系统级虚拟化，使操作系统内核支持多用户空间实体，例如Parallels Virtuozzo Containers，chroot，Solaris上的Zone
    \end{itemize}
    \item 应用程序虚拟化，在操作系统和应用程序间建立虚拟环境
    \begin{itemize}
      \item 便携式应用程序，允许程序在便携式设备中运行而不用在操作系统中安装
      \item 跨平台虚拟化，允许针对特定CPU或者操作系统的软件不做修改就能运行在其他平台上，例如Wine
      \item 虚拟设备，运行于虚拟化平台之上，面向应用的虚拟机映像
      \item 模拟器
    \end{itemize}
  \end{itemize}
  \item 虚拟内存，将不相邻的内存区，甚至硬盘空间虚拟成统一连续的内存地址
  \item 存储虚拟化，将实体存储空间（如硬盘）分隔成不同的逻辑存储空间
  \item 网络虚拟化，将不同网络的硬件和软件资源结合成一个虚拟的整体
  \begin{itemize}
    \item 虚拟专用网络（VPN），在大型网络（通常是Internet）中的不同计算机（节点）通过加密连接而组成的虚拟网络，具有类似局域网的功能
    \item 存储器虚拟化，将网络系统中的随机存储器聚合起来，形成统一的虚拟内存池
  \end{itemize}
  \item 桌面虚拟化，在本地计算机显示和操作远程计算机桌面，在远程计算机执行程序和储存信息
\end{itemize}
\subsection{虚拟化技术的发展}
现在，由于虚拟化技术在x86服务器上的迅速普及已经引发了虚拟化技术的热潮，尤其是英特尔的VT$^{TM}$和AMD的AMD-V$^{TM}$技术对x86架构硬件虚拟化的支持。虚拟化技术最初只是应用在大型主机上，大型机上的虚拟分区技术最早可以追溯到上世纪六、七十年代。早在上世纪60 年代，IBM 公司就发明了一种操作系统虚拟机技术，允许用户在一台主机上运行多个操作系统，让用户尽可能地充分利用昂贵的大型机资源。

最早使用虚拟化技术的是IBM 7044 计算机。IBM之后，在上世纪60年代还开发了型号为Model 67的System/360主机。Model 67 主机通过虚拟机监控器(Virtual Machine Monitor，简称VMM)虚拟所有的硬件接口。1965年IBM公司的“M44/44X”计算机项目，定义了虚拟内存管理机制，用户程序可以运行在虚拟的内存中，对于用户来说，这些虚拟内存就好像一个个“虚拟机”，为多个用户的程序提供了独立的计算环境。

IBM提出的虚拟机技术，使一批新产品涌现了出来，比如：IBM360/40，IBM360/67，以及VM/370，这些机器在当时都具有虚拟机功能，通过VMM技术在物理硬件之上生成了很多可以运行独立操作系统软件的虚拟机实例。

由于虚拟化技术技术在商业应用上的优势，RISC服务器与小型机成为了虚拟化技术第二代受益者。1999年，IBM公司在AS/400 上提出了上“逻辑分区(LPAR)”技术和新的高可用性集群解决方案。在POWER管理程序上运行的AS/400 LPAR令单台服务器工作起来如同12个独立的服务器。而在2002年，IBM 还更进一步，其AIX5L v5.2还首次包括了IBM实现的动态逻辑分区（DLPAR）。DLPAR允许在无需重启系统的情况下，将包括处理器、内存和其它组件在内的系统资源分配给独立的分区。这种在不中断运行的情况下进行资源分配的能力不仅令系统管理变得更加轻松，而且因为能够更好地使用资源而帮助降低总拥有成本。\cite{ibm_virtual_his}

不过，尽管惠普、Sun公司也跟随IBM在自己的RISC服务器上提供了虚拟化技术，但由于真正使用大型机和小型机的用户还是少数，加上各家产品和技术之间并不兼容，虚拟化技术仍旧不太被公众所关注。而现在，虚拟化技术的发展已经惠及到了x86架构。

此前，虚拟化技术在x86架构上进展缓慢的主要原因是x86架构本身不适合进行虚拟化，不过这个障碍已经由英特尔、AMD修改，x86处理器的指令集得到解决;还有一个原因是x86处理器的性能不足，这一原因也由于x86处理器在性能上的飞速提高得到了解决。由于x86架构的广泛普及，x86架构上的虚拟化技术也得到了比以前更大的关注。

随着x86平台上虚拟化技术的实现，首次向人们展示了虚拟化应用的广阔前景，因为x86平台可以提供便宜的、高性能和高可靠的服务器。更重要的是，一些用户已经开始配置虚拟化的生产环境，他们需要得到新的管理工具，从而随着虚拟化技术的发展而得到更大的收益。

不过，与已经有多年历史的UNIX服务器、大型主机上的虚拟化技术相比，x86服务器上的虚拟化仍旧处于早期阶段-根据英特尔的蓝图，在处理器当中集成硬件辅助虚拟化指令只是IA平台上的第一步，而在第二步则要实现I/O方面的虚拟化，直到最后实现整个IA平台的虚拟化。也就是说，目前的x86平台上，仅仅能够实现在处理器级别的虚拟化，在I/O以及其他方面的虚拟化还需要进一步的发展。不仅如此，x86架构上的虚拟化技术还无法完美实现虚拟分区之间动态迁移，而这些在UNIX平台、大型主机上早已不是问题。

自2006年以来，从处理器层面的AMD和Intel到操作系统层面的微软的加入，从数量众多的第三方软件厂商的涌现到服务器系统厂商的高调，我们看到一个趋于完整的服务器虚拟化的产业生态系统正在逐渐形成。这也使得在过去的一两年时间里，虚拟化开始成为广受关注的热点话题。整体看来，随着计算机新技术的飞速发展，虚拟化的前景和若干年前相比几乎彻底改变了，新的虚拟化平台前景十分乐观。

随着x86架构虚拟化的普及，高效的资源调度管理平台，整体解决方案，行之有效的资源调度、分配策略也成了研究的重点，也成为了该领域内比较重要的课题。
\section{资源调度系统}
\subsection{资源调度系统的分类}
资源调度系统按照不同的分类标准，可以很多种不同的调度系统。调度系统在具体的应用背景下可能需要特定的调度机制支持，因此有以下几类：

根据调度策略是脱机还是联机实现，调度系统可分为：
\begin{itemize}
  \item 静态调度-调度策略在一次运行前已经确定
  \item 动态调度-调度策略在运行过程种实施，可根据系统的运行状态调整
\end{itemize}

根据系统分类，可分为：
\begin{itemize}
  \item 单处理器调度-典型的应用如操作系统
  \item 集中式多处理器调度或者集中式仲裁
  \item 分布式调度-分布式管理系统
\end{itemize}

按照任务的可否抢占需求，系统可分为：
\begin{itemize}
  \item 支持抢占的调度
  \item 不可抢占的调度
\end{itemize}

按照任务对时延的要求，可分为：
\begin{itemize}
  \item 强实时调度
  \item 弱实时调度
  \item 非实时调度
\end{itemize}

\subsection{典型的虚拟机系统}
1. \textbf{Xen}

在工业界，Xen\cite{camxen}已经渐渐成为一个实际存在的工业标准，并且已经有成功的商业案例，比如Citrix，拥有着包括Citrix XenServer，Citrix NetScaler，Citrix XenApp，Citrix XenDesktop等产品。Xen 是剑桥大学计算机系开发的一个开源虚拟机监控器项目，使用Xen 可以使单一物理主机上同时运行多个操作系统，并且具有很好的隔离性。Xen 可以对启动后的采用标准虚拟化技术的虚拟机进行资源的动态调度，而且可以给Guest OS 分配大于物理CPU 个数的VCPU。 在Xen 中，不但可以映射不同的VCPU 到物理CPU，也可以调整CPU 运行队列来更改优先级。Xen的架构如图\ref{xen}，在虚拟层的基础上，Xen的Driver domain 相当于资源决策支持系统，它负责在监控器提供数据的基础上分配这些虚拟资源。
\begin{figure}[thb]
 \centering
 \includegraphics[width=0.8\textwidth]{xen}
 \caption{Xen的架构}
 \label{xen}
\end{figure}

2. \textbf{VMware}

另外一个流行的虚拟化产品是VMware Infrastructure\cite{VMwareInfrastructure}，通过其Virtual Center可以提供资源管理功能，将处理器和内存资源分配给运行在服务器上的多个虚拟机，为CPU、内存、磁盘和网络带宽确定最小、最大和按比例共享的资源共享，在虚拟机运行的同时支持修改分配，使应用程序能够动态获得更多资源以适应应用峰值性能的需要，从而形成一个具有内置负载平衡能力的自我管理、优化和有效的虚拟机资源调度管理环境。并且，其中的VMware DRS可以跨资源池不间断地监控利用率，并根据反映业务需求和变化的优先级的预定义规则，在多个虚拟机之间智能分配资源。当某个虚拟机负载增加时，VMware DRS通过改变虚拟机在资源池中所在的物理主机来获得更多的资源，例如将该虚拟机迁移到比较空闲的一台机器上。VMware DRS的动态虚拟机迁移机制主要面对的是环境中主机之间的动态资源分配，而不是单机多CPU多核架构（SMP和NUMA，Non Uniform Memory Access非一致访问分布共享存储技术）中的动态资源分配，也没有提供对高性能计算任务的优化，还有VMware目前只能在自家的vCenter使用。VMware DRS的动态迁移如图\ref{DRS} 所示。
\begin{figure}[tbh]
 \centering
 \includegraphics[width=0.8\textwidth]{DRS}
 \caption{VMware DRS在虚拟机之前平衡资源}
 \label{DRS}
\end{figure}

3. \textbf{Libvirt}

 Libvirt\cite{libvirtsite}库是一种实现 Linux 虚拟化功能的 Linux API，它支持各种虚拟机监控程序，包括 Xen 和 KVM，以及 QEMU 和用于其他操作系统的一些虚拟产品。前两款产品都是实际完整的架构，而讲到向外扩展计算（比如云计算），Libvirt可能是未曾听过的一个最重要的库之一。Libvirt 提供一种虚拟机监控程序不可知的API来安全管理运行于主机上的Guest OS。Libvirt 本身构建于一种抽象的概念之上，它为受支持的虚拟机监控器实现常用功能―比如基于监控数据作出决策，提供通用的API支持。如图\ref{libvirt} 所示的是Libvirt的基本架构，表示了Libvirt的比较和用例模型，其中右图中深色标记的Libvirt为其在虚拟环境中的位置。
 \begin{figure}[tbh]
 \centering
 \includegraphics[width=0.8\textwidth]{libvirt}
 \caption{Libvirt的比较和用例模型}
 \label{libvirt}
\end{figure}

使用 Libvirt，有两种不同的控制方式。第一种如图\ref{libvirt}右所示，其中管理应用程序和域位于同一节点上。管理应用程序通过 Libvirt 工作，以控制本地域。当管理应用程序和域位于不同节点上时，便产生了另一种控制方式（如图\ref{libvirtd}）。因此需要进行远程通信。该模式使用一种运行于远程节点上、名为 libvirtd 的特殊守护进程。当在新节点上安装 Libvirt 时该程序会自动启动，且可自动确定本地虚拟机监控程序并为其安装驱动程序。该管理应用程序通过一种通用协议从本地 libvirt 连接到远程 libvirtd。据此，可以开发出管理分布式虚拟资源的调度系统。
 \begin{figure}[tbh]
 \centering
 \includegraphics[width=0.8\textwidth]{libvirtd}
 \caption{使用Libvirtd控制远程虚拟机监控程序}
 \label{libvirtd}
\end{figure}
\section{关键技术及分析}
\subsection{资源监控}
虚拟资源的调度系统的基础是监控系统，它在整个系统中起着重要的作用，全面、合理、迅速的信息采集能够使决策模块全方面了解虚拟机的情况以及主机的性能，从而帮助上层决策系统做出相应的调度决策。虚拟机的信息监控模块需要考虑以下问题：
\begin{enumerate}
  \item 信息采集的全面性

  能够监控多个虚拟机的CPU、内存利用率、虚拟网络负载和虚拟块设备负载等等。为了较准确判断虚拟机资源消耗和利用情况，需要能够实时监控虚拟机每个VCPU的资源利用率和运行状态信息。
  \item 实时性和准确性

  数据更新要及时，数据信息一定要准确。
  \item 实用性

  不禁能够监控虚拟机的资源消耗，还应该监控硬件资源的运行以及资源消耗情况
  \item 资源开销

  信息监控的开销要小，不能影响系统的性能，要保证信息监测的执行不会抢占虚拟机的有限资源
\end{enumerate}
\subsection{资源调度策略}
虚拟资源总是有限的，无限的资源仅仅是一种理想态，因此我们需要调度机制。资源调度机制是一个调度系统的核心，它负责从监控的数据中分析，然后基于预定的决策给出解决方案，决定这些虚拟资源的去向。一个调度系统的优秀与否与调度系统的是否高效有着直接的关系。

资源调度总是希望达到以下技术要求：

\begin{itemize}
  \item 资源利用率

  最大化的利用资源是几乎每个调度系统首要考虑的问题。虚拟资源是有限的，资源请求又是不均衡的，如何合理的调度，使这些有限的资源以一个合理的组态最大化的利用是重点。
  \item 负载均衡

  负载均衡是希望实现集群中每个机器的负载在一个均衡的状态，平均分配客户的请求到各个虚拟机，以此解决快速获取资源，解决大量并发访问问题。
  \item 公平

  如何在满足自己需求的情况下最大化的获得公平性是DRF算法提出的观点。公平的情况下可以获得更好的均衡特性和防竞争性质。

  \item 实时动态调度

  虚拟机在运行的过程中，希望调度系统能够动态地在线调度任务，给这些任务分配资源，而不是静态地分配。
\end{itemize}

\section{本章小结}
本章详细介绍了虚拟化技术的分类与发展情况，对现有资源调度系统进行了归类，然后依据架构图分析了Xen的调度模块、VMware DRS 调度机制，并详细介绍了Libvirt。最后，对资源调度系统的关键技术进行了分析。






